name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: Install Dependencies
      run: |
        flutter doctor -v
        flutter pub get
    
    - name: Generate App Icons
      run: flutter pub run flutter_launcher_icons
    
    - name: Build Windows
      run: flutter build windows --release
    
    - name: Archive Windows Build
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/windows/x64/runner/Release/
    
    - name: Create Windows ZIP
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath ZedMovie-Windows-x64.zip
    
    - name: Upload Windows Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: ZedMovie-Windows-x64
        path: ZedMovie-Windows-x64.zip

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libmpv-dev mpv
        sudo apt-get install -y libglu1-mesa xvfb
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: Install Flutter Dependencies
      run: |
        flutter doctor -v
        flutter pub get
        flutter config --enable-linux-desktop
    
    - name: Generate App Icons
      run: flutter pub run flutter_launcher_icons
    
    - name: Build Linux
      run: flutter build linux --release
    
    - name: Archive Linux Build
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: build/linux/x64/release/bundle/
    
    - name: Create Linux TAR
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd build/linux/x64/release/bundle
        tar -czf ../../../../../ZedMovie-Linux-x64.tar.gz *
    
    - name: Upload Linux Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: ZedMovie-Linux-x64
        path: ZedMovie-Linux-x64.tar.gz

  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: Install Dependencies
      run: |
        flutter doctor -v
        flutter pub get
        flutter config --enable-macos-desktop
    
    - name: Generate App Icons
      run: flutter pub run flutter_launcher_icons
    
    - name: Build macOS
      run: flutter build macos --release
    
    - name: Archive macOS Build
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: build/macos/Build/Products/Release/
    
    - name: Create macOS ZIP
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd build/macos/Build/Products/Release
        zip -r ../../../../../ZedMovie-macOS.zip zedmoviedesktop.app
    
    - name: Upload macOS Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: ZedMovie-macOS
        path: ZedMovie-macOS.zip

  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ZedMovie-Windows-x64/ZedMovie-Windows-x64.zip
          ZedMovie-Linux-x64/ZedMovie-Linux-x64.tar.gz
          ZedMovie-macOS/ZedMovie-macOS.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üé¨ ZedMovie Desktop Release
          
          ### üì¶ Downloads
          - **Windows**: `ZedMovie-Windows-x64.zip`
          - **Linux**: `ZedMovie-Linux-x64.tar.gz`
          - **macOS**: `ZedMovie-macOS.zip`
          
          ### üöÄ What's New
          See the changelog below for details.
          
          ### üìù Installation
          Please refer to the [README](https://github.com/${{ github.repository }}/blob/main/README.md) for installation instructions.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

